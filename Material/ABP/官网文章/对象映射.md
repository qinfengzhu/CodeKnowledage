[TOC]

## 介绍

将相似的对象映射到另一个对象是很常见的。这也很乏味，而且重复，因为通常两个对象（类）可能有相似/相同的属性相互映射。请考虑以下典型的应用程序服务方法：

```
public class UserAppService : ApplicationService
{
    private readonly IRepository<User> _userRepository;

    public UserAppService(IRepository<User> userRepository)
    {
        _userRepository = userRepository;
    }

    public void CreateUser(CreateUserInput input)
    {
        var user = new User
        {
            Name = input.Name,
            Surname = input.Surname,
            EmailAddress = input.EmailAddress,
            Password = input.Password
        };

        _userRepository.Insert(user);
    }
}
```

CreateUserInput是一个简单的DTO，User是一个简单的实体。我们根据给定的输入手动创建一个用户实体。在真实的应用程序中，用户实体将拥有更多的属性，而手动创建它将变得乏味且容易出错。另外，当我们想向User和CreateUserInput添加新属性时，我们应该更改映射代码。

我们可以使用一个库自动生成这个映射。AutoMapper是最好的对象到对象映射库之一。ASP.NETboilerblate定义IObjectMapper接口来抽象它，并在中使用AutoMapper实现该接口Abp.AutoMapper 类库。

##  IObjectMapper 接口(IObjectMapper Interface)

IObjectMapper是一个简单的抽象，它具有将一个对象映射到另一个对象的映射方法。我们可以将上面的示例代码编写如下：

```
public class UserAppService : ApplicationService
{
    private readonly IRepository<User> _userRepository;
    private readonly IObjectMapper _objectMapper;

    public UserAppService(IRepository<User> userRepository, IObjectMapper objectMapper)
    {
        _userRepository = userRepository;
        _objectMapper = objectMapper;
    }

    public void CreateUser(CreateUserInput input)
    {
        var user = _objectMapper.Map<User>(input);
        _userRepository.Insert(user);
    }
}
```

Map是一个简单的方法，它获取源对象并创建一个新的目标对象，其类型声明为泛型参数（本例中为User）。Map方法有一个重载，可以将对象映射到现有对象。假设我们已经有一个用户实体，并希望通过一个对象更新它的属性：

```
public void UpdateUser(UpdateUserInput input)
{
    var user = _userRepository.Get(input.Id);
    _objectMapper.Map(input, user);
}
```

## AutoMapper 集成

Abp.AutoMapper nuget package(包) 实现了 IObjectMapper 接口并且提供了一些额外的功能特色。

### 安装

```
Install-Package Abp.AutoMapper
```

然后添加对 AbpAutoMapperModule 的依赖:

```
[DependsOn(typeof(AbpAutoMapperModule))]
public class MyModule : AbpModule
{
    ...
}
```

然后可以在代码中安全地注入和使用IObjectMapper。您也可以在需要时使用AutoMapper自己的API。

###  创建映射(Creating Mappings)

AutoMapper要求在使用映射之前定义类之间的映射（默认情况下）。关于映射的详细信息，您可以查看它自己的文档。ABP 使它更容易和模块化。

自动映射属性(Auto Mapping Attributes)

大多数时候，您只想直接（按惯例）映射类。在这种情况下，可以使用AutoMap、AutoMapFrom和AutoMapTo属性。例如，在上面的示例中，我们要将CreateUserInput类映射到User类，可以使用AutoMapTo属性，如下所示：

```
[AutoMapTo(typeof(User))]
public class CreateUserInput
{
    public string Name { get; set; }

    public string Surname { get; set; }

    public string EmailAddress { get; set; }

    public string Password { get; set; }
}
```

AutoMap属性向两个方向映射两个类。但是在这个示例中，我们只需要从CreateUserInput映射到User，所以我们使用AutoMapTo。

自定义映射(Custom Mapping)

在某些情况下，简单映射可能不适用。例如，两个类的属性名可能稍有不同，或者您可能希望在映射过程中忽略一些属性。在这种情况下，您应该直接使用AutoMapper的API来定义映射。Abp.AutoMapper package 定义了API，使这种自定义映射更加模块化。

假设我们要忽略映射时的密码，并且用户对EmailAddress转换为Email属性。我们可以定义如下所示的映射：

```
[DependsOn(typeof(AbpAutoMapperModule))]
public class MyModule : AbpModule
{
    public override void PreInitialize()
    {
        Configuration.Modules.AbpAutoMapper().Configurators.Add(config =>
        {
            config.CreateMap<CreateUserInput, User>()
                  .ForMember(u => u.Password, options => options.Ignore())
                  .ForMember(u => u.Email, options => options.MapFrom(input => input.EmailAddress));
        });
    }
}
```

AutoMapper有更多的对象到对象映射的选项和能力。更多信息，请参阅[文档](http://automapper.org/)。

### MapTo扩展方法(MapTo Extension Methods)

建议注入并使用前面定义的IObjectMapper接口。这使我们的项目尽可能独立于AutoMapper。它还使得单元测试更容易，因为我们可以在单元测试中替换（模拟）映射。

Abp.AutoMapper 模块还定义了MapTo扩展方法，这些方法可用于任何对象，以将其映射到另一个对象，而无需注入IObjectMapper。用法示例：

```
public class UserAppService : ApplicationService
{
    private readonly IRepository<User> _userRepository;

    public UserAppService(IRepository<User> userRepository)
    {
        _userRepository = userRepository;
    }

    public void CreateUser(CreateUserInput input)
    {
        var user = input.MapTo<User>();
        _userRepository.Insert(user);
    }

    public void UpdateUser(UpdateUserInput input)
    {
        var user = _userRepository.Get(input.Id);
        input.MapTo(user);
    }
}
```

MapTo 扩展方法定义在 Abp.AutoMapper 命名空间中，所以首先需要引用该空间到你的代码中。

由于 MapTo 扩展方法都是静态的，他使用了 AutoMapper的 静态实例(Mapper.Instance),对于应用程序代码来说，这很简单很好，但是在单元测试中可能会出现问题，因为静态配置和映射器在不同的测试之间共享，它们可能会相互影响。

### 单元测试

我们希望将测试相互隔离。为此，我们应该按照以下规则设计我们的项目：

1. 使用IObjectMapper 而不是使用 MapTo的扩展方法

2. 配置Abp.AutoMapper模块使用本地映射器实例（注册为单例到依赖项注入），而不是静态实例(Abp.AutoMapper使用静态映射器实例默认情况下，允许使用上面定义的MapTo扩展方法）：

```
Configuration.Modules.AbpAutoMapper().UseStaticMapper = false;
```

### (前置定义映射) Pre Defined Mappings

LocalizableString -> string

Abp.AutoMapper 模块定义将LocalizableString（或ILocalizableString）对象转换为字符串对象的映射。它使用ILocalizationManager进行转换，因此可本地化属性在任何类的映射过程中都会自动本地化。

### 注入IMapper(Injecting IMapper)

您可能需要直接使用AutoMapper的IMapper对象，而不是IObjectMapper抽象。在这种情况下，只需在类中注入IMapper并使用它。Abp汽车制造商包将IMapper注册为依赖注入作为单例。
