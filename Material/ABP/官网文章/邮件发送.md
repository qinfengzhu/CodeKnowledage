[TOC]

## 介绍

电子邮件发送是几乎每个应用程序都很常见的任务。ABP提供了一个基本的基础设施，可以简单地发送电子邮件，并将电子邮件服务器配置与发送电子邮件分开。

## IEmailSender

IEmailSender是一种在不知道细节的情况下发送电子邮件的服务。用法示例：

```
public class TaskManager : IDomainService
{
    private readonly IEmailSender _emailSender;

    public TaskManager(IEmailSender emailSender)
    {
        _emailSender = emailSender;
    }

    public void Assign(Task task, Person person)
    {
        //Assign task to the person
        task.AssignedTo = person;

        //Send a notification email
        _emailSender.Send(
            to: person.EmailAddress,
            subject: "You have a new task!",
            body: $"A new task is assigned for you: <b>{task.Title}</b>",
            isBodyHtml: true
        );
    }
}
```
我们只需注入IEmailSender并使用Send方法。Send方法还有几个重载。它还可以获取一个MailMessage对象（不适用于.netcore，因为.netcore不包括SmtpClient和MailMessage）。

### ISmtpEmailSender

还有一个ISmtpEmailSender，它扩展了IEmailSender并添加了BuildClient方法来创建一个SmtpClient来直接使用它（由于.net core不包括SmtpClient和MailMessage，.net core不可用）。在大多数情况下，使用IEmailSender就足够了。

### NullEmailSender

还有一个空对象模式实现IEmailSender作为NullEmailSender。您可以在单元测试中使用它，也可以使用属性注入模式来注入IEmalSender。

## 配置

电子邮件发送者使用设置管理系统(Setting Management)读取emal发送配置。所有设置名称都在中定义Abp.Net.Mail公司.EmailSettingNames类作为常量字符串。它们的价值和描述：

* __Abp.Net.Mail.DefaultFromAddress__ :  当您在发送电子邮件时未指定发件人时，用作发件人电子邮件地址（如上面的示例所示）。
* __Abp.Net.Mail.DefaultFromDisplayName__ :  当您在发送电子邮件时未指定发件人时，用作发件人显示名称（如上面的示例所示）。
* __Abp.Net.Mail.Smtp.Host__ :  SMTP服务器的IP/域（默认值：127.0.0.1）。
* __Abp.Net.Mail.Smtp.Port__ :  SMTP服务器的端口（默认值：25）。
* __Abp.Net.Mail.Smtp.UserName__ :  用户名，如果SMTP服务器需要身份验证。
* __Abp.Net.Mail.Smtp.Password__ :  密码，如果SMTP服务器需要身份验证。
* __Abp.Net.Mail.Smtp.Domain__ :  用户名的域，如果SMTP服务器需要身份验证。
* __Abp.Net.Mail.Smtp.EnableSsl__ :  值指示SMTP服务器是否使用SSL（“true”或“false”）。默认值：“false”）。
* __Abp.Net.Mail.Smtp.UseDefaultCredentials__ :  True，使用默认凭据而不是提供的用户名和密码（“True”或“false”）。默认值：“true”）。

## MailKit 集成

因为.net核心不支持标准命名空间System.Net.Mail.SmtpClient，所以我们需要第三方供应商来发送电子邮件。幸运的是，MailKit为默认的SmtpClient提供了一个很好的替代品。微软也建议这么做。

Abp.MailKit 包完全集成到ABP的电子邮件发送系统。因此，您仍然可以使用上述IEmailSender通过MailKit发送电子邮件。

### 安装

```
Install-Package Abp.MailKit
```

### 集成

你的模块添加对 AbpMailKitModule 的依赖

```
[DependsOn(typeof(AbpMailKitModule))]
public class MyProjectModule : AbpModule
{
    //...
}
```

### 用法

您可以按照前面所述使用IEmailSender，因为Abp.MailKit 包为它注册MailKit实现。它还使用上面定义的相同配置。

### 自定义

在创建MailKit的SmtpClient时，可能需要进行其他配置或自定义。在这种情况下，可以用自己的实现替换IMailKitSmtpBuilder接口。您可以从DefaultMailKitSmtpBuilder派生以使其更简单。例如，您可能希望接受所有SSL证书。在这种情况下，可以重写ConfigureClient方法，如下所示：

```
public class MyMailKitSmtpBuilder : DefaultMailKitSmtpBuilder
{
    public MyMailKitSmtpBuilder(ISmtpEmailSenderConfiguration smtpEmailSenderConfiguration)
        : base(smtpEmailSenderConfiguration)
    {
    }

    protected override void ConfigureClient(SmtpClient client)
    {
        client.ServerCertificateValidationCallback = (sender, certificate, chain, errors) => true;

        base.ConfigureClient(client);
    }
}
```
然后可以用模块的PreInitialize方法中的实现替换IMailKitSmtpBuilder接口：

```
[DependsOn(typeof(AbpMailKitModule))]
public class MyProjectModule : AbpModule
{
    public override void PreInitialize()
    {
        Configuration.ReplaceService<IMailKitSmtpBuilder, MyMailKitSmtpBuilder>();
    }

    //...
}
```
