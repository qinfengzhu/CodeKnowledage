[TOC]

## 介绍

ABP 提供了__IAbpSession__ 接口,无需使用asp.net session 就可以获取当前用户和租户的会话。IAbpSession 完全集成到了ABP的 [设置模块](设置管理.md) 与 [授权模块](授权.md) 中。

## 注入会话(Injecting Session)

IAbpSession通常是属性注入到所需的类中，除非没有会话信息就无法工作。如果我们使用属性注入，我们可以使用NullAbpsSession.Instance默认值如下：

```
public class MyClass : ITransientDependency
{
    public IAbpSession AbpSession { get; set; }

    public MyClass()
    {
        AbpSession = NullAbpSession.Instance;
    }

    public void MyMethod()
    {
        var currentUserId = AbpSession.UserId;
        //...
    }
}
```

由于身份验证/授权是一个应用层的任务，建议在应用层和上层使用IAbpSession（我们通常不在域层使用它）。ApplicationService、AbpController、AbpApiController和其他一些基类已经注入了AbpSession。因此，您可以直接在应用程序服务方法中使用AbpSession属性。

## Session 属性 (Properties)

AbpSession 定义了一些关键属性:

* __UserId__ : 当前用户的Id，如果没有当前用户，则为空。如果调用代码被授权，则不允许为空。

* __TenantId__ : 当前租户的Id，如果没有当前租户，则为空（如果用户尚未登录或他是主机用户）。

* __ImpersonatorUserId__ : 如果当前会话由另一个用户模拟，则模拟程序用户的Id。如果这不是模拟登录，则为空。

* __ImpersonatorTenantId__ : 如果当前会话由另一个用户模拟，则模拟程序用户的租户的Id。如果这不是模拟登录，则为空。

* __MultiTenancySide__ : 它可以是主机或租户。

UserId和TenantId可为null。还有不可为null的GetUserId（）和GetTenanId（）方法。如果确定存在当前用户，则可以调用GetUserId（）。如果当前用户为null，则此方法引发异常。getTenanId（）也类似。

模拟器属性与其他属性不同，通常用于审核日志记录。

> ClaimsAbpSession
ClaimsAbpsSession是IAbpSession接口的默认实现。它从当前用户的princical声明中获取会话属性（multitenacyside除外，它是计算的）。对于基于cookie的表单身份验证，它从cookies获取。因此，它与ASP.NET的身份验证机制是集成的.

## 重写当前会话 (Overriding Current Session Values)

在某些特定情况下，您可能需要更改/覆盖有限范围的会话值。在这种情况下，您可以使用IAbpSession.使用方法如下：

```
public class MyService
{
    private readonly IAbpSession _session;

    public MyService(IAbpSession session)
    {
        _session = session;
    }

    public void Test()
    {
        using (_session.Use(42, null))
        {
            var tenantId = _session.TenantId; //42
            var userId = _session.UserId; //null
        }
    }
}
```

Use方法返回IDisposable，必须将其释放。释放返回值后，会话值将自动还原为以前的值。

> 警告！
始终在上面所示的using块中使用它。否则，您可能会得到意外的会话值。可以使用嵌套的Use块，它们将按预期工作。

## 用户标识符 (User Identifier)

可以使用.ToUserIdentifier（）扩展方法从IAbpSession创建UserIdentifier对象。由于大多数API都使用UserIdentifier，这将简化为为当前用户创建一个UserIdentifier对象。
